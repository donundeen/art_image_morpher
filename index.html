<html>
<head>
	<style type="text/css">
canvas {
    padding-left: 0;
    padding-right: 0;
    margin-left: auto;
    margin-right: auto;
    display: block;
    width: 800px;
}
	</style>
	<script src="morpher.js"></script>
<!--	<script type="text/javascript" src="jquery.min.js" /> -->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
<script src="js/clmtrackr.js"></script>
<script src="js/Stats.js"></script>
<script src="js/utils.js"></script>
<script src="models/model_pca_20_svm.js"></script>	
	<script type="text/javascript">
	console.log("in start");

	var morphtime = 4000;
	var waitTime = 1000;



var imageArray = ["DP161260.jpg",
				"32_100.43.jpg",
				"http://images.metmuseum.org/CRDImages/ep/web-large/co.ep.1971.86_16.1.jpg",
				"http://images.metmuseum.org/CRDImages/ep/web-large/DT254471.jpg",
				"http://images.metmuseum.org/CRDImages/ep/web-large/DT2774.jpg",
				"http://images.metmuseum.org/CRDImages/ep/web-large/DT390.jpg"
				];
// triangles are indexes of points, forming a mesh.

//var imageArray = [image1, image2, image3, image4];

for(i = 0; i<imageArray.length; i++){
	console.log(imageArray[i]);
	if(imageArray[i].match(/^http:\/\//i)){
		console.log("modding");
		imageArray[i] = "image_proxy.php?img="+ imageArray[i];
	}
}


var noFacesImages = {};

var tmpImage= "DT229079.jpg";


$( document ).ready(function() {



	var page = 0;
	var numMorphs = 0;


	shuffle(imageArray);

	function shuffle(array) {
	  var currentIndex = array.length, temporaryValue, randomIndex ;

	  // While there remain elements to shuffle...
	  while (0 !== currentIndex) {

	    // Pick a remaining element...
	    randomIndex = Math.floor(Math.random() * currentIndex);
	    currentIndex -= 1;

	    // And swap it with the current element.
	    temporaryValue = array[currentIndex];
	    array[currentIndex] = array[randomIndex];
	    array[randomIndex] = temporaryValue;
	  }

	  return array;
	}

	function findMoreImages(){
		page++;
		// start scrapi loop
		var searchUrl = "http://www.scrapi.org/search/portrait?page=";
		var page = 1;
		var theUrl = searchUrl + page;
		console.log("calling " + theUrl);
		$.ajax({
			url : theUrl,
			success : function(result){
				items = result.collection.items;
				shuffle(items);
				if(items.length == 0){
					page=0;
					findMoreImages();
				}
				for(i = 0; i < items.length; i++){
					item = items[i];
					var thumb = item.image_thumb;
					var imageUrl = "image_proxy.php?img="+ thumb.replace(/web-thumb/,"web-large");
					imageArray.push(imageUrl);
				}
			},
			error : function(x, status, message){
				console.log("got error");
			}

		});
	}


	findMoreImages();

	var currentImage = 0;

	console.log("startedsss");
/*
	var morpher = new Morpher(json);
	document.body.appendChild(morpher.canvas);
	morpher.set([1, 0]);
	morpher.animate([0, 1], 2000);
*/

	$("#trackerimages").hide();


	var first = true;
	var positions1;
	var positions2;
	var image1width;
	var image1height;

	var morphPair = [];

	var ctrack;

	var currentImage = imageArray.shift();
	imageArray.push(currentImage);

	startFindFaces(currentImage);

	var drawRequest;
	

	// detect if tracker fails to find a face
	document.addEventListener("clmtrackrNotFound", function(event) {
		ctrack.stop();
		ctrack.reset();
		console.log(" clmtrackrNotFound The tracking had problems with finding a face in this image. Try selecting the face in the image manually.")
		noFacesImages[currentImage] = currentImage;

		var ri = imageArray.indexOf(currentImage);
		if(ri > -1){
			 imageArray.splice(ri, 1);
		}

		currentImage = imageArray.shift();
		imageArray.push(currentImage);

		if(imagesData[currentImage] && imagesData[currentImage].positions){
			morphPair.push({imagename: currentImage, positions: imagesData[currentImage].positions });

			if(morphPair.length == 1){
				currentImage = imageArray.shift();
				imageArray.push(currentImage);
				startFindFaces(currentImage);
			}else if (morphPair.length > 2){
				morphPair.shift();			
			}

			if(morphPair.length ==2){

				morph2faces(morphPair[0].imagename, morphPair[0].positions, morphPair[1].imagename, morphPair[1].positions);
			}				
		}else{
			startFindFaces(currentImage);
		}


	}, false);
	
	// detect if tracker loses tracking of face
	document.addEventListener("clmtrackrLost", function(event) {
		ctrack.stop();
		ctrack.reset();
		console.log(" clmtrackrLost The tracking had problems converging on a face in this image. Try selecting the face in the image manually.")

		noFacesImages[currentImage] = currentImage;

		currentImage = imageArray.shift();
		imageArray.push(currentImage);

		if(imagesData[currentImage] && imagesData[currentImage].positions){
			morphPair.push({imagename: currentImage, positions: imagesData[currentImage].positions });

			if(morphPair.length == 1){
				currentImage = imageArray.shift();
				imageArray.push(currentImage);
				startFindFaces(currentImage);
			}else if (morphPair.length > 2){
				morphPair.shift();			
			}

			if(morphPair.length ==2){
				morph2faces(morphPair[0].imagename, morphPair[0].positions, morphPair[1].imagename, morphPair[1].positions);
			}				
		}else{
			startFindFaces(currentImage);
		}



	}, false);
	

	// detect if tracker has converged

	document.addEventListener("clmtrackrConverged", function(event) {

		console.log(event);
		// stop drawloop
		cancelRequestAnimFrame(drawRequest);
	    positions = ctrack.getCurrentPosition();

		ctrack.stop();
		ctrack.reset();

		
		if(!imagesData[currentImage]){
			imagesData[currentImage]= {};
		}
		imagesData[currentImage].positions = positions;

		morphPair.push({imagename: currentImage, positions: positions });

		if(morphPair.length == 1){
			currentImage = imageArray.shift();
			imageArray.push(currentImage);
			startFindFaces(currentImage);
		}else if (morphPair.length > 2){
			morphPair.shift();			
		}

		if(morphPair.length ==2){
			morph2faces(morphPair[0].imagename, morphPair[0].positions, morphPair[1].imagename, morphPair[1].positions);
		}
	}, false);
	
	var imagesData = {};
	function startFindFaces(imagename){


		console.log("finding on "  + imagename);
		var cc = document.getElementById('image1').getContext('2d');
		if(typeof ctrack !== 'undefined'){
			console.log("resetting");
			ctrack.stop();
			ctrack.reset();
			delete ctrack;
		}else{
			ctrack = new clm.tracker({stopOnConvergence : true});
		}
		img = new Image();
		ctrack.init(pModel);			

	//	ctrack = new clm.tracker({stopOnConvergence : true});
		img.onload = function() {
			image2width = this.width;
			image2height = this.height;

			imagesData[imagename] = {};

			imagesData[imagename].width = this.width;
			imagesData[imagename].height = this.height;

			cc.drawImage(img,0,0,this.width, this.height);
			ctrack.start(document.getElementById('image1'));
		};
		img.src = imagename;

	}

	var morpher = false;
	function morph2faces(image1, positions1, image2, positions2){
		/*
		console.log(image1);
		console.log(positions1);
		console.log(image2);
		console.log(positions2);
*/	
		var image1width = imagesData[image1].width;
		var image1height = imagesData[image1].height;
		var image2width = imagesData[image2].width;
		var image2height = imagesData[image2].width;

		positions1.push([0,0]);  // 71  ul
		positions1.push([image1width / 2, 0]); // 72 um
		positions1.push([image1width, 0]); //73 ur
		positions1.push([image1width, image1height /2]); //74 mr
		positions1.push([image1width, image1height]); //75 lr
		positions1.push([image1width / 2, image1height]); //76 lm
		positions1.push([0, image1height]); //77 ll
		positions1.push([0, image1height / 2]);  //78 ml

		positions2.push([0,0]);  // 71
		positions2.push([image2width / 2, 0]); // 72
		positions2.push([image2width, 0]); //73
		positions2.push([image2width, image2height /2]); //74
		positions2.push([image2width, image2height]); //75
		positions2.push([image2width / 2, image2height]); //76
		positions2.push([0, image2height]); //77
		positions2.push([0, image2height / 2]);  //78


		var json = {images: [{src:image1, points : []},{src:image2, points : []}], triangles : []};

		json.triangles = [[0,3,7],
						[7,11,14],
						[33,36,38],
						[0,7,14],
						[0,14,62],
						[0,14,33],
						[0,62, 72],
						[14,62,72],
						[71,72,20],
						[72,73,16],
						[72,20,16],
						[44,53,50],
						[44,50,47],
						[20,0,33],
						[16,14,33],
						[16,20,33],
						[71,78,20],
						[73,74,16],
						[74,75,7],
						[75,76,7],
						[11,7,74],
						[14,11,74],
						[76,77,7],
						[77,78,7],
						[77,78,3],
						[78,71,3],
						[78,71,0],
						[7,3,78],
						[3,0,78],
						[23,0,19],
						[23,19,20],
						[71,78,23],
						[74, 14,16]
						];

//		fosr(var i=0; i<positions1.length; i++){
		for(var i=0; i<positions1.length; i++){

			var position1 = positions1[i];
			var position2 = positions2[i];
			if(position1 && position2){
				json.images[0].points.push({x : position1[0], y: position1[1]});
				json.images[1].points.push({x : position2[0], y: position2[1]});
			}
		}


		console.log(json);

//		var morpher = new Morpher(json);
//		$("#morpherhere").html(morpher.canvas);

		if(!morpher){
			morpher = new Morpher(json);
			$("#morpherhere").html(morpher.canvas);
			morpher.set([1, 0]);
		}else{
			console.log(morpher);
			//morpher.reset();

			// here I'm tryig to move to the next morphing, without re-initing the morpher canvas. But sometimes the canvas size resets in an uncool ways.
			morpher.fromJSON(json);
//			morpher.updateCanvasSize();
			morpher.set([1]);
		}


		
		morpher.animate([0, 1], morphtime);



		numMorphs++;
		if(numMorphs >= imageArray.length){
			findMoreImages();
		}

		setTimeout(function(){

			currentImage = imageArray.shift();
			imageArray.push(currentImage);

			if(imagesData[currentImage] && imagesData[currentImage].positions){
				morphPair.push({imagename: currentImage, positions: imagesData[currentImage].positions });

				if(morphPair.length == 1){
					currentImage = imageArray.shift();
					imageArray.push(currentImage);
					startFindFaces(currentImage);
				}else if (morphPair.length > 2){
					morphPair.shift();			
				}
				if(morphPair.length ==2){
					morph2faces(morphPair[0].imagename, morphPair[0].positions, morphPair[1].imagename, morphPair[1].positions);
				}				
			}else{
				startFindFaces(currentImage);
			}
		}, morphtime + waitTime)

	}

}); 



	</script>
</head>
<body style="background-color:black;">
	<div style="align: center;" id="morpherhere"></div>
	<div id="trackerimages">
			<div id="container1">
				<canvas id="image1" width="625" height="500"></canvas>
				<canvas id="overlay1" width="625" height="500"></canvas>
			</div>
			<div id="container2">
				<canvas id="image2" width="625" height="500"></canvas>
				<canvas id="overlay2" width="625" height="500"></canvas>
			</div>
	</div>

</body>
</html>